<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Genre Getter</title>
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
    <style type="text/css">
        head {
            background-color: #192227;
            color: #f0f0f0;
        }
        
        #login,
        #loggedin {
            display: none;
        }
        
        .login-btn {
            margin: 65px 145px;
        }
        
        .container {
            position: absolute;
            left: 0;
            top: 0;
            margin: 0;
            padding: 15px;
            width: 450px;
        }
        
        .dl-horizontal {
            display: grid;
            grid-template-columns: max-content auto;
        }
        
        .dl-horizontal dt {
            grid-column-start: 1;
            width: 70px;
            margin: 0;
            text-align: right;
        }
        
        .dl-horizontal dd {
            grid-column-start: 2;
            margin-left: 10px;
            width: calc(100% - 10px);
        }
        
        .text-overflow {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="login">
            <a href="/login" class="login-btn btn btn-primary">Log in with Spotify</a
        >
      </div>
      <div id="loggedin">
        <dic id="user"></dic>
        <div id="info">You are not playing any music at the moment.</div>
      </div>
    </div>

    <script id="user-template" type="text/x-handlebars-template">
      <h2>Welcome {{display_name}}</h2>
    </script>

    <script id="info-template" type="text/x-handlebars-template">
      <h3>Currently playing</h3>
      <dl class="dl-horizontal">
        <dt>Track</dt>
        <dd>{{track}}</dd>
        <dt>Artists</dt>
        <dd class="text-overflow">{{artists}}</dd>
        <dt>Genres</dt>
        <dd class="text-overflow">{{genres}}</dd>
      </dl>
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script>
      (function () {
        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
        function getHashParams() {
          var hashParams = {};
          var e,
            r = /([^&;=]+)=?([^&;]*)/g,
            q = window.location.hash.substring(1);
          while ((e = r.exec(q))) {
            hashParams[e[1]] = decodeURIComponent(e[2]);
          }
          return hashParams;
        }
        var userSource = document.getElementById("user-template").innerHTML,
          userTemplate = Handlebars.compile(userSource),
          userPlaceholder = document.getElementById("user");

        var infoSource = document.getElementById("info-template").innerHTML,
          infoTemplate = Handlebars.compile(infoSource),
          infoPlaceholder = document.getElementById("info");

        var display_name, info_track, info_artists, info_genres;

        var params = getHashParams();

        var access_token = params.access_token,
          refresh_token = params.refresh_token,
          error = params.error;

        if (error) {
          alert("There was an error during the authentication: " + error);
        } else {
          function get_current_song() {
            $.ajax({
              type: "GET",
              url: "https://api.spotify.com/v1/me/player",
              headers: {
                Authorization: "Bearer " + access_token,
                "Content-Type": "application/json",
              },
              success: function (res) {
                if (res !== undefined && res.item !== undefined) {
                  info_track = res.item.name;
                  info_artists = "";
                  info_genres = "";
                  artist = res.item.artists[0].name;
                  for (i in res.item.artists) {
                    info_artists += res.item.artists[i].name;
                    if (i < res.item.artists.length - 1) {
                      info_artists += ", ";
                    }
                  }

                  try {
                    fetchGenres();
                  } catch {
                    console.log("Error fetching genres");
                    infoPlaceholder.innerHTML = infoTemplate({
                      track: info_track,
                      artists: artistsnames,
                    });
                  }
                }
              },
              error: function (res) {
                $.ajax({
                  type: "GET",
                  url: "/refresh_token",
                  data: {
                    refresh_token: refresh_token,
                  },
                }).done(function (data) {
                  access_token = data.access_token;
                });
              },
            });
          }
        }

        function fetchGenres() {
          $.ajax({
            url: "/get_genres",
            data: {
              track: info_track,
              artist: artist,
            },
            success: function (res) {
              if (res.genres !== undefined && res.genres.length > 0) {
                var info_genres = "",
                  len = res.genres.length > 5 ? 5 : res.genres.length;
                for (var i = 0; i < len; i++) {
                  info_genres += res.genres[i].name + ", ";
                }
              } else {
                info_genres = "No genres found";
              }
              infoPlaceholder.innerHTML = infoTemplate({
                track: info_track,
                artists: info_artists,
                genres: info_genres,
              });
            },
          });
        }

        var interval = false;

        if (access_token) {
          $.ajax({
            url: "https://api.spotify.com/v1/me",
            headers: {
              Authorization: "Bearer " + access_token,
            },
            success: function (response) {
              display_name = response.display_name;
              userPlaceholder.innerHTML = userTemplate(response);

              $("#login").hide();
              $("#loggedin").show();
              interval = setInterval(get_current_song, 1000);
            },
          });
        } else {
          // render initial screen
          $("#login").show();
          $("#loggedin").hide();
          clearInterval(interval);
        }
      })();
    </script>
  </body>
</html>